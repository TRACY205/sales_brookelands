{% extends "base.html" %}
{% block title %}User Dashboard{% endblock %}

{% block content %}

<style>
  .dashboard-container {
    max-width: 900px;
    margin: 30px auto;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .dashboard-container h2 {
    text-align: center;
    color: #333;
    margin-bottom: 20px;
  }
  .message {
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
  }
  .message.success {
    background-color: #ddffdd;
    color: #3c763d;
    border: 1px solid #3c763d;
  }
  .message.error {
    background-color: #ffdddd;
    color: #a94442;
    border: 1px solid #a94442;
  }
  .top-links {
    text-align: right;
    margin-bottom: 20px;
  }
  .top-links a {
    margin-left: 10px;
    text-decoration: none;
    font-weight: 500;
  }
  .top-links a.register { color: #007BFF; }
  .top-links a.logout { color: #d9534f; }

  .order-form {
    padding: 20px;
    border: 1px solid #eee;
    border-radius: 10px;
    background: #fafafa;
    margin-bottom: 30px;
  }
  .order-form h3 {
    margin-bottom: 15px;
    color: #444;
  }
  .order-form label {
    font-weight: 500;
  }
  .order-form input,
  .order-form select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    margin-bottom: 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  .order-form button {
    width: 100%;
    padding: 12px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }
  .order-form button:hover {
    background: #218838;
  }

  .orders-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #ddd;
  }
  .orders-table th,
  .orders-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
  }
  .orders-table th {
    background: #f2f2f2;
  }
  .orders-table .empty {
    text-align: center;
    padding: 15px;
    color: #777;
  }

  /* ‚úÖ Payment style */
  .payment-options {
    margin-bottom: 15px;
  }
  .payment-options label {
    margin-right: 20px;
  }
</style>

<div class="dashboard-container">

  <h2>Welcome, {{ user.username }}</h2>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="message {% if message.tags == 'error' %}error{% else %}success{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <p class="top-links">
    <a href="{% url 'register' %}" class="register">‚ûï Register a new user</a> | 
    <a href="{% url 'logout' %}" class="logout">üö™ Logout</a>
  </p>

  <!-- Order Form -->
  <div class="order-form">
    <h3>üì¶ Submit New Order</h3>
    <form method="post" onsubmit="return validateForm()">
      {% csrf_token %}
      
      <label>Category</label>
      <select id="category" name="category" required>
        <option value="">--Select Category--</option>
        <option value="Water">Water</option>
        <option value="Bottle">Bottle</option>
      </select>

      <label>Item</label>
      <select id="item" name="item" required>
        <option value="">--Select Item--</option>
      </select>

      <label>Quantity</label>
      <input type="number" id="quantity" name="quantity" min="1" required>

      <label>Total Price</label>
      <input type="text" id="price" name="price" readonly required>

      <!-- ‚úÖ Payment Method -->
      <label>Payment Method</label>
      <div class="payment-options">
        <label><input type="checkbox" name="payment_method" value="Cash"> Cash</label>
        <label><input type="checkbox" name="payment_method" value="MPesa"> MPesa</label>
      </div>

      <button type="submit">‚úÖ Submit Order</button>
    </form>
  </div>

  <!-- Orders Table -->
  <h3>üìã Your Previous Orders</h3>
  <table class="orders-table">
    <tr>
      <th>ID</th>
      <th>Category</th>
      <th>Item</th>
      <th>Quantity</th>
      <th>Price</th>
      <th>Date</th>
      <th>Payment</th>
    </tr>
    {% for sale in sales %}
    <tr>
      <td>{{ sale.id }}</td>
      <td>{{ sale.category }}</td>
      <td>{{ sale.item }}</td>
      <td>{{ sale.quantity }}</td>
      <td>{{ sale.price }}</td>
      <td>{{ sale.date|date:"Y-m-d H:i" }}</td>
      <td>{{ sale.payment_method }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="7" class="empty">No orders yet.</td>
    </tr>
    {% endfor %}
  </table>
</div>

<script>
const itemsWithPrices = {
  "Water": {
    "1L + B": 30,
    "1L (Refill)": 10,
    "5L (Refill)": 70,
    "5L + Bottle": 150,
    "10L (Refill)": 130,
    "10L + Bottle": 250,
    "20L (Refill)": 250,
    "20L + Bottle": 500,
    "20L (Hard) + Water": 1500
  },
  "Bottle": {
    "20L Bottle": 0, 
    "10L Bottle": 0,
    "5L Bottle": 0
  }
};

const categorySelect = document.getElementById("category");
const itemSelect = document.getElementById("item");
const priceInput = document.getElementById("price");
const qtyInput = document.getElementById("quantity");

let unitPrice = 0;

categorySelect.addEventListener("change", function() {
    const category = this.value;
    itemSelect.innerHTML = "<option value=''>--Select Item--</option>";
    priceInput.value = "";
    unitPrice = 0;

    if (itemsWithPrices[category]) {
        Object.keys(itemsWithPrices[category]).forEach(item => {
            const opt = document.createElement("option");
            opt.value = item;
            opt.text = item;
            itemSelect.appendChild(opt);
        });
    }
});

itemSelect.addEventListener("change", function() {
    const category = categorySelect.value;
    const item = this.value;
    if (itemsWithPrices[category] && itemsWithPrices[category][item] !== undefined) {
        unitPrice = itemsWithPrices[category][item];
        updateTotal();
    } else {
        unitPrice = 0;
        priceInput.value = "";
    }
});

qtyInput.addEventListener("input", updateTotal);

function updateTotal() {
    const qty = parseInt(qtyInput.value) || 0;
    priceInput.value = unitPrice * qty;
}

// ‚úÖ Validation before submit
function validateForm() {
  if (!priceInput.value || priceInput.value === "0") {
    alert("‚ö†Ô∏è Please select category, item, and quantity before submitting.");
    return false;
  }

  // Check if payment selected
  const payments = document.querySelectorAll('input[name="payment_method"]:checked');
  if (payments.length === 0) {
    alert("‚ö†Ô∏è Please select at least one payment method.");
    return false;
  }

  return true;
}
</script>

{% endblock %}
